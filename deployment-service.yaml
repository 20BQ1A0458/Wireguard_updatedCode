initContainers:
  - name: wireguard-setup
    image: ubuntu:latest
    command:
      - /bin/bash
      - -c
      - |
        # Install necessary packages
        apt-get update && apt-get install -y \
          wireguard \
          wireguard-tools \
          iproute2 \
          iptables \
          iputils-ping \
          curl \
          && apt-get clean && rm -rf /var/lib/apt/lists/*

        # Generate WireGuard private and public keys
        PRIVATE_KEY=$(wg genkey)
        PUBLIC_KEY=$(echo "$PRIVATE_KEY" | wg pubkey)

        # Extract pod index from pod name (e.g., node-wireguard-0 or node-wireguard-1)
        POD_NAME=$(hostname)
        POD_INDEX=$(echo "$POD_NAME" | grep -oE '[0-9]+$')
        LISTEN_PORT=$((51820 + POD_INDEX))  # Assign unique port per pod (51820 for first, 51821 for second, etc.)
        PEER_IP="10.8.0.$((POD_INDEX + 1))"  # Assign dynamic IP (10.8.0.1 for first pod, 10.8.0.2 for second, etc.)

        # Generate WireGuard configuration dynamically
        mkdir -p /etc/wireguard

        # Write the WireGuard configuration
        cat <<EOF > /etc/wireguard/wg0.conf
        [Interface]
        PrivateKey=$PRIVATE_KEY
        Address=10.8.0.$((POD_INDEX + 1))/24
        ListenPort=$LISTEN_PORT
        SaveConfig=true

        [Peer]
        PublicKey=$PEER_PUBLIC_KEY  # Replace this with dynamically provided peer public key if needed
        AllowedIPs=0.0.0.0/0
        EOF

        # Save the private and public keys to the container
        echo "$PRIVATE_KEY" > /etc/wireguard/privatekey
        echo "$PUBLIC_KEY" > /etc/wireguard/publickey

        # Enable IP forwarding inside the container for WireGuard to work
        echo "1" > /proc/sys/net/ipv4/ip_forward
        sysctl -p || true  # Ignore errors from sysctl due to container isolation

        # Set up iptables for NAT and forwarding (No UFW, using iptables directly)
        iptables -A FORWARD -i wg0 -j ACCEPT
        iptables -A FORWARD -o wg0 -j ACCEPT
        iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
        iptables -t nat -A POSTROUTING -o wg0 -j MASQUERADE

        # Bring up the WireGuard interface
        wg-quick up wg0 || echo "WireGuard setup failed."
    securityContext:
      privileged: true  # Required to run iptables and WireGuard commands
      capabilities:
        add:
          - NET_ADMIN
    volumeMounts:
      - name: wireguard-config
        mountPath: /etc/wireguard
